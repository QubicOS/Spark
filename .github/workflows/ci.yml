name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  go-test:
    name: Go test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Go test (CGO disabled)
        run: |
          CGO_ENABLED=0 go test ./...
      - name: Go build (CGO disabled)
        run: |
          CGO_ENABLED=0 go build ./...

  tinygo-rp2350:
    name: TinyGo (RP2350 / Pico 2)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: tinygo-org/setup-tinygo@v2
        with:
          tinygo-version: "0.40.1"
      - name: Build UF2
        run: |
          mkdir -p build
          tinygo version
          tinygo build -target=pico2 -size=short -o build/spark-pico2.uf2 .
      - uses: actions/upload-artifact@v4
        with:
          name: spark-pico2-uf2
          path: build/spark-pico2.uf2

  tinygo-picocalc:
    name: TinyGo (PicoCalc)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: tinygo-org/setup-tinygo@v2
        with:
          tinygo-version: "0.40.1"
      - name: Build UF2
        run: |
          mkdir -p build
          tinygo version
          tinygo build -target=pico -tags=picocalc -size=short -o build/spark-picocalc.uf2 .
      - uses: actions/upload-artifact@v4
        with:
          name: spark-picocalc-uf2
          path: build/spark-picocalc.uf2

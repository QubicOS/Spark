# Идея SparkOS

SparkOS — микроядерная ОС, спроектированная вокруг модели выполнения, а не вокруг железа, UI или POSIX-совместимости.
Её цель — быть маленькой, понятной и расширяемой без переписывания фундамента.

## Принципы

1) Ядро — механизм, а не платформа.

- Кооперативное планирование.
- Только модель задач и IPC.
- Ядро не знает про UI, ФС, время, сеть как «системные подсистемы».
- Ядро не интерпретирует сообщения.

2) Всё — задачи, и все равны.

- Нет «особых» процессов.
- Нет привилегированных приложений.
- init/UI/shell — обычные задачи.

3) Capability вместо иллюзии защиты (MMU нет).

- Доступ к ресурсу возможен только через capability.
- Capability принадлежит задаче и передаётся только явно через IPC.
- При завершении задачи её capability уничтожаются.
- Нет глобальных ресурсов «по имени».

4) IPC — единственный язык системы.

- Задачи не вызывают друг друга напрямую.
- Сервисы не знают клиентов.
- HAL не знает про IPC.

5) HAL — контракт.

- HAL не содержит логики ОС.
- Две реализации: baremetal и emulator на хосте.
- ОС обязана работать на host emulator до появления железа.

6) UI — сервис.

- UI Service — единственный владелец framebuffer/input.
- «Консоль/uart как интерфейс» не является целевым UX.

## Модель выполнения (что фиксируем до роста кода)

**Сущности:**
- Task: единица исполнения (кооперативная).
- Endpoint: адрес IPC.
- Capability: (endpoint + rights), единственный способ доступа к endpoint/ресурсу.
- Message: фиксированный конверт данных + опционально перенос capability.

Протоколы и семантика IPC: `docs/ipc.md`.
Планирование и блокировки: `docs/scheduler.md`.

**Инварианты:**
- Ядро ничего не «понимает» в сообщениях.
- Любой доступ к сервису = IPC на capability.
- Любая политика и «системные абстракции» живут в userland-сервисах.

## С чего начать (порядок реализации)

1) Host dev-loop (обязательный фундамент).

- Хостовый запуск с UI-окном и с headless-режимом.
- Детерминированные прогоны «N тиков / N шагов» для тестов.

2) IPC и capability как контракт.

- Описать минимальные протоколы сообщений (kinds/форматы/ошибки).
- Стабилизировать семантику: блокировка, очередь, переполнение.

3) Сервисы поверх IPC.

- Logger (как сервис), Time (sleep/alarms), UI (framebuffer/input).
- Следом: Flash FS service, process-like launch service (если нужен), net service.

4) Baremetal (RP2350 / TinyGo).

- TinyGo target: `pico2`.
- Сначала полный функциональный эквивалент host (без «особых путей»).

## Билды

- Dev (host): быстрый запуск и отладка, опционально race detector.
- Prod (host): `-trimpath`, `-ldflags -s -w`, build metadata.
- Prod (RP2350): TinyGo UF2 + flashing.
